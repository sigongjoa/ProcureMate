{% extends "base.html" %}

{% block title %}설정 - ProcureMate GUI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>시스템 설정</h1>
        <p class="text-muted">ProcureMate 설정 관리</p>
    </div>
</div>

<!-- 탭 네비게이션 -->
<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="llm-tab" data-bs-toggle="tab" data-bs-target="#llm-content" type="button" role="tab">
                    <i class="fas fa-lightbulb me-2"></i>LLM 설정
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="vectordb-tab" data-bs-toggle="tab" data-bs-target="#vectordb-content" type="button" role="tab">
                    <i class="fas fa-database me-2"></i>Vector DB
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-content" type="button" role="tab">
                    <i class="fas fa-code me-2"></i>외부 API
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-content" type="button" role="tab">
                    <i class="fas fa-cog me-2"></i>시스템 설정
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-content" type="button" role="tab">
                    <i class="fas fa-file-alt me-2"></i>템플릿 관리
                </button>
            </li>
        </ul>
    </div>
</div>

<!-- 탭 내용 -->
<div class="tab-content mt-4" id="settingsTabContent">
    <!-- LLM 설정 탭 -->
    <div class="tab-pane fade show active" id="llm-content" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">LLM 설정</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="LlmServerUrl" class="form-label">LLM 서버 URL</label>
                            <input type="url" class="form-control" id="LlmServerUrl" value="http://localhost:1234/v1" placeholder="http://localhost:1234/v1">
                            <div class="form-text">LM Studio 또는 Ollama 서버 주소를 입력하세요.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="LlmModel" class="form-label">모델명</label>
                            <input type="text" class="form-control" id="LlmModel" value="llama-3.1-8b-instruct" placeholder="llama-3.1-8b-instruct">
                            <div class="form-text">사용할 LLM 모델명을 입력하세요.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="LlmTemperature" class="form-label">Temperature: <span id="TempDisplay">0.7</span></label>
                            <input type="range" class="form-range" id="LlmTemperature" min="0" max="1" step="0.1" value="0.7">
                            <div class="form-text">창의성 조절 (0: 보수적, 1: 창의적)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="LlmMaxTokens" class="form-label">Max Tokens</label>
                            <select class="form-select" id="LlmMaxTokens">
                                <option value="512">512</option>
                                <option value="1024" selected>1024</option>
                                <option value="2048">2048</option>
                                <option value="4096">4096</option>
                            </select>
                            <div class="form-text">최대 출력 토큰 수</div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="testLLM()">
                            <i class="fas fa-play me-2"></i>연결 테스트
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveLLMSettings()">
                            <i class="fas fa-save me-2"></i>설정 저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vector DB 설정 탭 -->
    <div class="tab-pane fade" id="vectordb-content" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Vector DB 설정</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="ChromaDbPath" class="form-label">ChromaDB 경로</label>
                            <input type="text" class="form-control" id="ChromaDbPath" value="./chroma_db" placeholder="./chroma_db">
                            <div class="form-text">ChromaDB 데이터베이스 파일 저장 경로</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="CollectionName" class="form-label">컬렉션명</label>
                            <input type="text" class="form-control" id="CollectionName" value="procurement_data" placeholder="procurement_data">
                            <div class="form-text">Vector DB 컬렉션 이름</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="EmbeddingModel" class="form-label">임베딩 모델</label>
                            <select class="form-select" id="EmbeddingModel">
                                <option value="all-MiniLM-L6-v2" selected>all-MiniLM-L6-v2 (빠름)</option>
                                <option value="all-mpnet-base-v2">all-mpnet-base-v2 (정확함)</option>
                                <option value="sentence-transformers/paraphrase-multilingual-mpnet-base-v2">paraphrase-multilingual-mpnet-base-v2 (다국어)</option>
                            </select>
                            <div class="form-text">문서 임베딩에 사용할 모델</div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="testVectorDB()">
                            <i class="fas fa-play me-2"></i>연결 테스트
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveVectorDBSettings()">
                            <i class="fas fa-save me-2"></i>설정 저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 외부 API 설정 탭 -->
    <div class="tab-pane fade" id="api-content" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">외부 API 설정</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="border-bottom pb-2 mb-3">G2B (나라장터) API</h6>
                        <div class="mb-3">
                            <label for="G2bApiKey" class="form-label">G2B API 키</label>
                            <input type="password" class="form-control" id="G2bApiKey" placeholder="API 키를 입력하세요">
                            <div class="form-text">나라장터 데이터 연계 서비스 API 키</div>
                        </div>
                        
                        <h6 class="border-bottom pb-2 mb-3 mt-4">쿠팡 파트너스 API</h6>
                        <div class="mb-3">
                            <label for="CoupangAccessKey" class="form-label">액세스 키</label>
                            <input type="password" class="form-control" id="CoupangAccessKey" placeholder="액세스 키를 입력하세요">
                        </div>
                        
                        <div class="mb-3">
                            <label for="CoupangSecretKey" class="form-label">시크릿 키</label>
                            <input type="password" class="form-control" id="CoupangSecretKey" placeholder="시크릿 키를 입력하세요">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="testAPIs()">
                            <i class="fas fa-play me-2"></i>API 테스트
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveAPISettings()">
                            <i class="fas fa-save me-2"></i>설정 저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 시스템 설정 탭 -->
    <div class="tab-pane fade" id="system-content" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">시스템 설정</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="DebugMode">
                                <label class="form-check-label" for="DebugMode">
                                    <strong>디버그 모드</strong>
                                    <div class="text-muted small">상세 로그 출력 및 디버깅 정보 표시</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="AutoSave" checked>
                                <label class="form-check-label" for="AutoSave">
                                    <strong>자동 저장</strong>
                                    <div class="text-muted small">테스트 결과 및 설정 자동 저장</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="LogLevel" class="form-label">로그 레벨</label>
                            <select class="form-select" id="LogLevel">
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO" selected>INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="MaxResults" class="form-label">최대 검색 결과 수</label>
                            <input type="number" class="form-control" id="MaxResults" value="10" min="1" max="100">
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="saveSystemSettings()">
                            <i class="fas fa-save me-2"></i>설정 저장
                        </button>
                        <button type="button" class="btn btn-warning" onclick="resetSettings()">
                            <i class="fas fa-undo me-2"></i>기본값으로 초기화
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 템플릿 관리 탭 -->
    <div class="tab-pane fade" id="template-content" role="tabpanel">
        <div class="row">
            <div class="col-md-12">
                <h5 class="mb-3">프롬프트 엔지니어링 및 템플릿 관리</h5>
                <p class="text-muted">시스템에서 사용하는 프롬프트와 문서 템플릿을 관리합니다.</p>
            </div>
        </div>
        
        <!-- 프롬프트 카테고리 선택 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">프롬프트 카테고리</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="PromptCategory" class="form-label">카테고리 선택</label>
                                <select class="form-select" id="PromptCategory" onchange="loadPromptsByCategory()">
                                    <option value="">카테고리를 선택하세요</option>
                                    <option value="llm_prompts">LLM 분석 프롬프트</option>
                                    <option value="document_generation_prompts">문서 생성 프롬프트</option>
                                    <option value="document_form_prompts">문서 양식 프롬프트</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="PromptName" class="form-label">프롬프트 선택</label>
                                <select class="form-select" id="PromptName" onchange="loadSelectedPrompt()">
                                    <option value="">프롬프트를 선택하세요</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="button" class="btn btn-outline-primary" onclick="createNewPrompt()">
                                        <i class="fas fa-plus me-1"></i>새 프롬프트
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="deletePrompt()">
                                        <i class="fas fa-trash me-1"></i>삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 프롬프트 편집기 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">프롬프트 편집기</h6>
                        <div>
                            <small class="text-muted">사용 가능한 변수: {user_request}, {items}, {budget_range} 등</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="NewPromptName" class="form-label">프롬프트 이름</label>
                            <input type="text" class="form-control" id="NewPromptName" placeholder="예: analyze_procurement_request">
                        </div>
                        
                        <div class="mb-3">
                            <label for="PromptContent" class="form-label">프롬프트 내용</label>
                            <textarea class="form-control" id="PromptContent" rows="12" 
                                      placeholder="프롬프트 템플릿을 입력하세요...\n\n예시:\n다음 조달 요청을 분석하여 JSON 형태로 응답해주세요.\n\n요청 내용: {user_request}\n\n분석할 항목:\n1. 필요한 물품 목록 (items)\n2. 각 물품의 수량 (quantities)\n3. 긴급도 (urgency)\n4. 예산 범위 (budget_range)"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">프롬프트 미리보기</label>
                            <div class="border p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                <div id="PromptPreview" class="text-muted">프롬프트를 입력하면 미리보기가 표시됩니다.</div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success" onclick="savePrompt()">
                                <i class="fas fa-save me-1"></i>프롬프트 저장
                            </button>
                            <button type="button" class="btn btn-primary" onclick="testPrompt()">
                                <i class="fas fa-play me-1"></i>프롬프트 테스트
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetPromptEditor()">
                                <i class="fas fa-undo me-1"></i>초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 프롬프트 목록 및 정보 -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">현재 카테고리 프롬프트</h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="PromptList">
                            <div class="text-muted text-center py-3">
                                카테고리를 선택하세요
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">프롬프트 변수 가이드</h6>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="variableGuide">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#llmVars">
                                        LLM 분석 변수
                                    </button>
                                </h2>
                                <div id="llmVars" class="accordion-collapse collapse" data-bs-parent="#variableGuide">
                                    <div class="accordion-body">
                                        <small>
                                            <code>{user_request}</code> - 사용자 요청<br>
                                            <code>{items}</code> - 물품 목록<br>
                                            <code>{quantities}</code> - 수량<br>
                                            <code>{urgency}</code> - 긴급도<br>
                                            <code>{budget_range}</code> - 예산 범위
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#docVars">
                                        문서 생성 변수
                                    </button>
                                </h2>
                                <div id="docVars" class="accordion-collapse collapse" data-bs-parent="#variableGuide">
                                    <div class="accordion-body">
                                        <small>
                                            <code>{product_data}</code> - 제품 정보<br>
                                            <code>{requirement_data}</code> - 요구사항<br>
                                            <code>{matching_scores}</code> - 매칭 점수<br>
                                            <code>{procurement_plan}</code> - 조달 계획
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#formVars">
                                        문서 양식 변수
                                    </button>
                                </h2>
                                <div id="formVars" class="accordion-collapse collapse" data-bs-parent="#variableGuide">
                                    <div class="accordion-body">
                                        <small>
                                            <code>{RequesterName}</code> - 요청자명<br>
                                            <code>{Department}</code> - 부서<br>
                                            <code>{ItemName}</code> - 품목명<br>
                                            <code>{Quantity}</code> - 수량<br>
                                            <code>{EstimatedPrice}</code> - 예상가격
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HTML 템플릿 관리 -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">HTML 문서 템플릿 관리</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="TemplateFileName" class="form-label">템플릿 파일명</label>
                                    <input type="text" class="form-control" id="TemplateFileName" placeholder="예: procurement_request.html">
                                </div>
                                <div class="mb-3">
                                    <label for="HTMLTemplateContent" class="form-label">HTML 템플릿 내용</label>
                                    <textarea class="form-control" id="HTMLTemplateContent" rows="8" 
                                              placeholder="HTML 템플릿을 입력하세요..."></textarea>
                                </div>
                                <button type="button" class="btn btn-success" onclick="saveHTMLTemplate()">
                                    <i class="fas fa-save me-1"></i>HTML 템플릿 저장
                                </button>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">저장된 HTML 템플릿</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="HTMLTemplateList">
                                            <div class="list-group" id="templateFileList">
                                                <div class="text-muted text-center py-3">
                                                    저장된 템플릿이 없습니다
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 결과 모달 -->
<div class="modal fade" id="ResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ResultModalTitle">테스트 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ResultModalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 모달 -->
<div class="modal fade" id="LoadingModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="loading-spinner"></div>
                <span id="LoadingText">처리 중...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Temperature 슬라이더 업데이트
document.getElementById('LlmTemperature').addEventListener('input', function() {
    document.getElementById('TempDisplay').textContent = this.value;
});

// 프롬프트 및 템플릿 관리 전역 변수
let currentPrompts = {};
let currentCategory = '';

// 프롬프트 내용 업데이트 시 미리보기 업데이트
document.getElementById('PromptContent').addEventListener('input', function() {
    updatePromptPreview();
});

// 프롬트 미리보기 업데이트
function updatePromptPreview() {
    const content = document.getElementById('PromptContent').value;
    const preview = document.getElementById('PromptPreview');
    
    if (content.trim()) {
        // 예시 데이터로 변수 치환
        let previewContent = content
            .replace(/{user_request}/g, '"사무용 의자 10개 구매 예산 100만원"')
            .replace(/{items}/g, '["사무용 의자"]')
            .replace(/{quantities}/g, '["10개"]')
            .replace(/{urgency}/g, '"보통"')
            .replace(/{budget_range}/g, '"100만원"')
            .replace(/{product_data}/g, '"제품 정보 예시"')
            .replace(/{requirement_data}/g, '"요구사항 예시"');
        
        preview.innerHTML = previewContent;
        preview.className = '';
    } else {
        preview.innerHTML = '프롬프트를 입력하면 미리보기가 표시됩니다.';
        preview.className = 'text-muted';
    }
}

// 카테고리별 프롬프트 로드
async function loadPromptsByCategory() {
    const category = document.getElementById('PromptCategory').value;
    const promptNameSelect = document.getElementById('PromptName');
    const promptList = document.getElementById('PromptList');
    
    if (!category) {
        promptNameSelect.innerHTML = '<option value="">프롬프트를 선택하세요</option>';
        promptList.innerHTML = '<div class="text-muted text-center py-3">카테고리를 선택하세요</div>';
        return;
    }
    
    currentCategory = category;
    
    try {
        const response = await fetch(`/api/prompts/${category}`);
        const prompts = await response.json();
        currentPrompts = prompts;
        
        // 프롬프트 선택 드롭다운 업데이트
        promptNameSelect.innerHTML = '<option value="">프롬프트를 선택하세요</option>';
        Object.keys(prompts).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            promptNameSelect.appendChild(option);
        });
        
        // 프롬프트 목록 업데이트
        const listHtml = Object.keys(prompts).map(name => `
            <div class="list-group-item list-group-item-action" onclick="selectPromptFromList('${name}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${name}</h6>
                    <small class="text-muted">${prompts[name].length} 문자</small>
                </div>
                <p class="mb-1">${prompts[name].substring(0, 100)}...</p>
            </div>
        `).join('');
        
        promptList.innerHTML = listHtml || '<div class="text-muted text-center py-3">프롬프트가 없습니다</div>';
        
    } catch (error) {
        console.error('프롬프트 로드 오류:', error);
        promptList.innerHTML = '<div class="text-danger text-center py-3">프롬프트 로드 실패</div>';
    }
}

// 리스트에서 프롬프트 선택
function selectPromptFromList(promptName) {
    document.getElementById('PromptName').value = promptName;
    loadSelectedPrompt();
}

// 선택된 프롬프트 로드
function loadSelectedPrompt() {
    const promptName = document.getElementById('PromptName').value;
    
    if (!promptName || !currentPrompts[promptName]) {
        return;
    }
    
    document.getElementById('NewPromptName').value = promptName;
    document.getElementById('PromptContent').value = currentPrompts[promptName];
    updatePromptPreview();
}

// 새 프롬프트 생성
function createNewPrompt() {
    document.getElementById('NewPromptName').value = '';
    document.getElementById('PromptContent').value = '';
    document.getElementById('PromptName').value = '';
    updatePromptPreview();
}

// 프롬프트 저장
async function savePrompt() {
    const category = document.getElementById('PromptCategory').value;
    const promptName = document.getElementById('NewPromptName').value;
    const content = document.getElementById('PromptContent').value;
    
    if (!category) {
        alert('카테고리를 선택해주세요.');
        return;
    }
    
    if (!promptName.trim()) {
        alert('프롬프트 이름을 입력해주세요.');
        return;
    }
    
    if (!content.trim()) {
        alert('프롬프트 내용을 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/api/prompts/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                category: category,
                name: promptName,
                content: content
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('프롬프트가 저장되었습니다.');
            loadPromptsByCategory(); // 목록 새로고침
        } else {
            alert('프롬프트 저장 실패: ' + result.error);
        }
        
    } catch (error) {
        alert('프롬프트 저장 오류: ' + error.message);
    }
}

// 프롬프트 삭제
async function deletePrompt() {
    const category = document.getElementById('PromptCategory').value;
    const promptName = document.getElementById('PromptName').value;
    
    if (!category || !promptName) {
        alert('삭제할 프롬프트를 선택해주세요.');
        return;
    }
    
    if (!confirm(`'${promptName}' 프롬프트를 삭제하시겠습니까?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/prompts/delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                category: category,
                name: promptName
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('프롬프트가 삭제되었습니다.');
            resetPromptEditor();
            loadPromptsByCategory();
        } else {
            alert('프롬프트 삭제 실패: ' + result.error);
        }
        
    } catch (error) {
        alert('프롬프트 삭제 오류: ' + error.message);
    }
}

// 프롬프트 테스트
async function testPrompt() {
    const content = document.getElementById('PromptContent').value;
    
    if (!content.trim()) {
        alert('테스트할 프롬프트를 입력해주세요.');
        return;
    }
    
    showLoading('프롬프트 테스트 중...');
    
    try {
        const response = await fetch('/api/prompts/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                prompt: content,
                test_data: {
                    user_request: "사무용 의자 10개 구매 예산 100만원",
                    items: ["사무용 의자"],
                    quantities: ["10개"],
                    urgency: "보통",
                    budget_range: "100만원"
                }
            })
        });
        
        const result = await response.json();
        hideLoading();
        
        showResult('프롬프트 테스트 결과', result);
        
    } catch (error) {
        hideLoading();
        showResult('프롬프트 테스트 실패', {success: false, error: error.message});
    }
}

// 프롬프트 편집기 초기화
function resetPromptEditor() {
    document.getElementById('NewPromptName').value = '';
    document.getElementById('PromptContent').value = '';
    document.getElementById('PromptName').value = '';
    updatePromptPreview();
}

// HTML 템플릿 저장
async function saveHTMLTemplate() {
    const fileName = document.getElementById('TemplateFileName').value;
    const content = document.getElementById('HTMLTemplateContent').value;
    
    if (!fileName.trim()) {
        alert('템플릿 파일명을 입력해주세요.');
        return;
    }
    
    if (!content.trim()) {
        alert('HTML 템플릿 내용을 입력해주세요.');
        return;
    }
    
    try {
        const response = await fetch('/api/templates/html', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                filename: fileName,
                content: content
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('HTML 템플릿이 저장되었습니다.');
            loadHTMLTemplates();
        } else {
            alert('HTML 템플릿 저장 실패: ' + result.error);
        }
        
    } catch (error) {
        alert('HTML 템플릿 저장 오류: ' + error.message);
    }
}

// HTML 템플릿 목록 로드
async function loadHTMLTemplates() {
    try {
        const response = await fetch('/api/templates/html');
        const templates = await response.json();
        
        const listElement = document.getElementById('templateFileList');
        
        if (templates.length === 0) {
            listElement.innerHTML = '<div class="text-muted text-center py-3">저장된 템플릿이 없습니다</div>';
            return;
        }
        
        const listHtml = templates.map(template => `
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${template.name}</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadHTMLTemplate('${template.name}')">로드</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteHTMLTemplate('${template.name}')">삭제</button>
                    </div>
                </div>
                <small class="text-muted">수정일: ${template.modified}</small>
            </div>
        `).join('');
        
        listElement.innerHTML = listHtml;
        
    } catch (error) {
        console.error('HTML 템플릿 로드 오류:', error);
    }
}

// HTML 템플릿 로드
async function loadHTMLTemplate(filename) {
    try {
        const response = await fetch(`/api/templates/html/${filename}`);
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('TemplateFileName').value = filename;
            document.getElementById('HTMLTemplateContent').value = result.content;
        } else {
            alert('HTML 템플릿 로드 실패: ' + result.error);
        }
        
    } catch (error) {
        alert('HTML 템플릿 로드 오류: ' + error.message);
    }
}

// HTML 템플릿 삭제
async function deleteHTMLTemplate(filename) {
    if (!confirm(`'${filename}' 템플릿을 삭제하시겠습니까?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/templates/html/${filename}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('HTML 템플릿이 삭제되었습니다.');
            loadHTMLTemplates();
        } else {
            alert('HTML 템플릿 삭제 실패: ' + result.error);
        }
        
    } catch (error) {
        alert('HTML 템플릿 삭제 오류: ' + error.message);
    }
}

// LLM 연결 테스트
async function testLLM() {
    showLoading('LLM 연결 테스트 중...');
    
    try {
        const response = await fetch('/api/llm/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query: "테스트 메시지입니다.",
                temperature: parseFloat(document.getElementById('LlmTemperature').value),
                max_tokens: parseInt(document.getElementById('LlmMaxTokens').value)
            })
        });
        
        const result = await response.json();
        hideLoading();
        showResult('LLM 테스트 결과', result);
        
    } catch (error) {
        hideLoading();
        showResult('LLM 테스트 실패', {success: false, error: error.message});
    }
}

// Vector DB 연결 테스트
async function testVectorDB() {
    showLoading('Vector DB 연결 테스트 중...');
    
    try {
        const response = await fetch('/api/vectordb/test');
        const result = await response.json();
        hideLoading();
        showResult('Vector DB 테스트 결과', result);
        
    } catch (error) {
        hideLoading();
        showResult('Vector DB 테스트 실패', {success: false, error: error.message});
    }
}

// API 테스트
async function testAPIs() {
    showLoading('API 연결 테스트 중...');
    
    try {
        const response = await fetch('/api/test/external');
        const result = await response.json();
        hideLoading();
        showResult('API 테스트 결과', result);
        
    } catch (error) {
        hideLoading();
        showResult('API 테스트 실패', {success: false, error: error.message});
    }
}

// 설정 저장 함수들
function saveLLMSettings() {
    const settings = {
        server_url: document.getElementById('LlmServerUrl').value,
        model: document.getElementById('LlmModel').value,
        temperature: parseFloat(document.getElementById('LlmTemperature').value),
        max_tokens: parseInt(document.getElementById('LlmMaxTokens').value)
    };
    
    fetch('/api/settings/llm', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('LLM 설정이 저장되었습니다.');
        } else {
            alert('설정 저장 실패: ' + result.error);
        }
    })
    .catch(error => alert('설정 저장 오류: ' + error.message));
}

function saveVectorDBSettings() {
    const settings = {
        chroma_path: document.getElementById('ChromaDbPath').value,
        collection_name: document.getElementById('CollectionName').value,
        embedding_model: document.getElementById('EmbeddingModel').value
    };
    
    fetch('/api/settings/vectordb', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Vector DB 설정이 저장되었습니다.');
        } else {
            alert('설정 저장 실패: ' + result.error);
        }
    })
    .catch(error => alert('설정 저장 오류: ' + error.message));
}

function saveAPISettings() {
    const settings = {
        g2b_api_key: document.getElementById('G2bApiKey').value,
        coupang_access_key: document.getElementById('CoupangAccessKey').value,
        coupang_secret_key: document.getElementById('CoupangSecretKey').value
    };
    
    fetch('/api/settings/api', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('API 설정이 저장되었습니다.');
        } else {
            alert('설정 저장 실패: ' + result.error);
        }
    })
    .catch(error => alert('설정 저장 오류: ' + error.message));
}

function saveSystemSettings() {
    const settings = {
        debug_mode: document.getElementById('DebugMode').checked,
        auto_save: document.getElementById('AutoSave').checked,
        log_level: document.getElementById('LogLevel').value,
        max_results: parseInt(document.getElementById('MaxResults').value)
    };
    
    fetch('/api/settings/system', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('시스템 설정이 저장되었습니다.');
        } else {
            alert('설정 저장 실패: ' + result.error);
        }
    })
    .catch(error => alert('설정 저장 오류: ' + error.message));
}

// 템플릿 관련 함수들
function saveTemplate() {
    const template = {
        name: document.getElementById('TemplateName').value,
        type: document.getElementById('TemplateType').value,
        content: document.getElementById('TemplateContent').value
    };
    
    if (!template.name || !template.content) {
        alert('템플릿 이름과 내용을 입력해주세요.');
        return;
    }
    
    fetch('/api/templates', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(template)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('템플릿이 저장되었습니다.');
            loadTemplates();
            document.getElementById('TemplateName').value = '';
            document.getElementById('TemplateContent').value = '';
        } else {
            alert('템플릿 저장 실패: ' + result.error);
        }
    })
    .catch(error => alert('템플릿 저장 오류: ' + error.message));
}

function loadTemplates() {
    fetch('/api/templates')
    .then(response => response.json())
    .then(templates => {
        const listElement = document.getElementById('TemplateList');
        if (templates.length === 0) {
            listElement.innerHTML = '<div class="text-muted text-center py-4">저장된 템플릿이 없습니다.</div>';
            return;
        }
        
        listElement.innerHTML = templates.map(template => `
            <div class="card mb-2">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">${template.name}</h6>
                            <small class="text-muted">${template.type}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="loadTemplate('${template.id}')">불러오기</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteTemplate('${template.id}')">삭제</button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    })
    .catch(error => console.error('템플릿 로드 오류:', error));
}

function loadTemplate(templateId) {
    fetch(`/api/templates/${templateId}`)
    .then(response => response.json())
    .then(template => {
        document.getElementById('TemplateName').value = template.name;
        document.getElementById('TemplateType').value = template.type;
        document.getElementById('TemplateContent').value = template.content;
    })
    .catch(error => alert('템플릿 로드 오류: ' + error.message));
}

function deleteTemplate(templateId) {
    if (confirm('정말로 이 템플릿을 삭제하시겠습니까?')) {
        fetch(`/api/templates/${templateId}`, {method: 'DELETE'})
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('템플릿이 삭제되었습니다.');
                loadTemplates();
            } else {
                alert('템플릿 삭제 실패: ' + result.error);
            }
        })
        .catch(error => alert('템플릿 삭제 오류: ' + error.message));
    }
}

function resetSettings() {
    if (confirm('모든 설정을 기본값으로 초기화하시겠습니까?')) {
        fetch('/api/settings/reset', {method: 'POST'})
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('설정이 초기화되었습니다. 페이지를 새로고침합니다.');
                location.reload();
            } else {
                alert('설정 초기화 실패: ' + result.error);
            }
        })
        .catch(error => alert('설정 초기화 오류: ' + error.message));
    }
}

// 유틸리티 함수들
function showLoading(text) {
    document.getElementById('LoadingText').textContent = text;
    new bootstrap.Modal(document.getElementById('LoadingModal')).show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('LoadingModal'));
    if (modal) modal.hide();
}

function showResult(title, result) {
    document.getElementById('ResultModalTitle').textContent = title;
    
    let content = '';
    if (result.success) {
        content = '<div class="alert alert-success">연결이 성공했습니다!</div>';
        if (result.data) {
            content += '<pre class="bg-light p-3 rounded">' + JSON.stringify(result.data, null, 2) + '</pre>';
        }
    } else {
        content = '<div class="alert alert-danger">연결이 실패했습니다.</div>';
        if (result.error) {
            content += '<div class="text-danger">' + result.error + '</div>';
        }
    }
    
    document.getElementById('ResultModalContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('ResultModal')).show();
}

// 페이지 로드 시 템플릿 목록 로드
document.addEventListener('DOMContentLoaded', function() {
    loadHTMLTemplates();
});
</script>
{% endblock %}

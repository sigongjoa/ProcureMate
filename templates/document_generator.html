{% extends "base.html" %}

{% block title %}ë¬¸ì„œ ìƒì„±ê¸° - ProcureMate GUI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-file-alt"></i> 
                í•œêµ­ ê¸°ì—… êµ¬ë§¤-ì¡°ë‹¬ ë¬¸ì„œ ìƒì„±ê¸°
            </h2>
            <p class="text-muted">9ê°€ì§€ í•µì‹¬ ì¡°ë‹¬ ë¬¸ì„œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="row">
        <!-- ë¬¸ì„œ íƒ€ì… ì„ íƒ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“‹ ë¬¸ì„œ íƒ€ì… ì„ íƒ</h5>
                </div>
                <div class="card-body">
                    <div id="DocumentTypeList" class="list-group">
                        <div class="text-center">
                            <div class="loading-spinner"></div>
                            ë¬¸ì„œ íƒ€ì… ë¡œë”© ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¬¸ì„œ ì…ë ¥ í¼ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“ ë¬¸ì„œ ì •ë³´ ì…ë ¥</h5>
                    <button id="GenerateButton" class="btn btn-primary btn-sm" disabled>
                        <i class="fas fa-magic"></i> ë¬¸ì„œ ìƒì„±
                    </button>
                </div>
                <div class="card-body">
                    <div id="DocumentFormContainer">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-mouse-pointer fa-3x mb-3"></i>
                            <p>ì¢Œì¸¡ì—ì„œ ë¬¸ì„œ íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒì„± ê²°ê³¼ -->
    <div class="row mt-4" id="ResultSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“„ ìƒì„±ëœ ë¬¸ì„œ</h5>
                    <div>
                        <button id="CopyButton" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="fas fa-copy"></i> ë³µì‚¬
                        </button>
                        <button id="DownloadButton" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download"></i> ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="GeneratedContent">
                        <!-- ìƒì„±ëœ ë¬¸ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì§„í–‰ìƒí™© ëª¨ë‹¬ -->
<div class="modal fade" id="ProgressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="loading-spinner mb-3"></div>
                <h5>ë¬¸ì„œ ìƒì„± ì¤‘...</h5>
                <p class="text-muted">AIê°€ ë¬¸ì„œë¥¼ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
class DocumentGenerator {
    constructor() {
        this.selectedDocumentType = null;
        this.documentTypes = [];
        this.currentFormData = {};
        this.init();
    }

    async init() {
        await this.loadDocumentTypes();
        this.setupEventListeners();
    }

    async loadDocumentTypes() {
        try {
            const response = await fetch('/api/documents/types');
            const result = await response.json();
            
            if (result.success) {
                this.documentTypes = result.data;
                this.renderDocumentTypeList();
            } else {
                this.showError('ë¬¸ì„œ íƒ€ì… ë¡œë”© ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('ë¬¸ì„œ íƒ€ì… ë¡œë”© ì˜¤ë¥˜:', error);
            this.showError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
        }
    }

    renderDocumentTypeList() {
        const container = document.getElementById('DocumentTypeList');
        
        if (this.documentTypes.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">ì‚¬ìš© ê°€ëŠ¥í•œ ë¬¸ì„œ íƒ€ì…ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        const listItems = this.documentTypes.map(type => `
            <button class="list-group-item list-group-item-action DocumentTypeItem" 
                    data-type="${type.id}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${type.name}</h6>
                    <small class="text-muted">${type.category}</small>
                </div>
                <p class="mb-1 text-muted small">${type.description}</p>
            </button>
        `).join('');

        container.innerHTML = listItems;
    }

    setupEventListeners() {
        // ë¬¸ì„œ íƒ€ì… ì„ íƒ
        document.addEventListener('click', (e) => {
            if (e.target.closest('.DocumentTypeItem')) {
                const button = e.target.closest('.DocumentTypeItem');
                const documentType = button.dataset.type;
                this.selectDocumentType(documentType);
            }
        });

        // ë¬¸ì„œ ìƒì„± ë²„íŠ¼
        document.getElementById('GenerateButton').addEventListener('click', () => {
            this.generateDocument();
        });

        // ë³µì‚¬ ë²„íŠ¼
        document.getElementById('CopyButton').addEventListener('click', () => {
            this.copyToClipboard();
        });

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        document.getElementById('DownloadButton').addEventListener('click', () => {
            this.downloadDocument();
        });
    }

    async selectDocumentType(documentType) {
        // ì´ì „ ì„ íƒ ì œê±°
        document.querySelectorAll('.DocumentTypeItem').forEach(item => {
            item.classList.remove('active');
        });

        // ìƒˆ ì„ íƒ ì ìš©
        document.querySelector(`[data-type="${documentType}"]`).classList.add('active');
        
        this.selectedDocumentType = documentType;

        // í¼ í•„ë“œ ë¡œë”©
        await this.loadFormFields(documentType);
    }

    async loadFormFields(documentType) {
        try {
            const response = await fetch(`/api/documents/${documentType}/fields`);
            const result = await response.json();
            
            if (result.success) {
                this.renderFormFields(result.data);
                document.getElementById('GenerateButton').disabled = false;
            } else {
                this.showError('í¼ í•„ë“œ ë¡œë”© ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('í¼ í•„ë“œ ë¡œë”© ì˜¤ë¥˜:', error);
            this.showError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
        }
    }

    renderFormFields(fields) {
        const container = document.getElementById('DocumentFormContainer');
        
        const formHTML = fields.map(field => {
            const fieldId = `field_${field.name}`;
            const required = field.required ? 'required' : '';
            const placeholder = field.placeholder ? `placeholder="${field.placeholder}"` : '';

            switch (field.field_type) {
                case 'textarea':
                    return `
                        <div class="mb-3">
                            <label for="${fieldId}" class="form-label">
                                ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                            <textarea class="form-control FormField" 
                                      id="${fieldId}" 
                                      name="${field.name}"
                                      rows="3" 
                                      ${placeholder} 
                                      ${required}></textarea>
                        </div>
                    `;
                case 'select':
                    const options = field.options ? field.options.map(opt => 
                        `<option value="${opt}">${opt}</option>`
                    ).join('') : '';
                    return `
                        <div class="mb-3">
                            <label for="${fieldId}" class="form-label">
                                ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                            <select class="form-select FormField" 
                                    id="${fieldId}" 
                                    name="${field.name}" 
                                    ${required}>
                                <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                                ${options}
                            </select>
                        </div>
                    `;
                case 'number':
                    return `
                        <div class="mb-3">
                            <label for="${fieldId}" class="form-label">
                                ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                            <input type="number" 
                                   class="form-control FormField" 
                                   id="${fieldId}" 
                                   name="${field.name}"
                                   ${placeholder} 
                                   ${required}>
                        </div>
                    `;
                case 'date':
                    return `
                        <div class="mb-3">
                            <label for="${fieldId}" class="form-label">
                                ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                            <input type="date" 
                                   class="form-control FormField" 
                                   id="${fieldId}" 
                                   name="${field.name}"
                                   ${required}>
                        </div>
                    `;
                default: // text
                    return `
                        <div class="mb-3">
                            <label for="${fieldId}" class="form-label">
                                ${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                            <input type="text" 
                                   class="form-control FormField" 
                                   id="${fieldId}" 
                                   name="${field.name}"
                                   ${placeholder} 
                                   ${required}>
                        </div>
                    `;
            }
        }).join('');

        container.innerHTML = `
            <form id="DocumentForm">
                ${formHTML}
            </form>
        `;
    }

    collectFormData() {
        const formData = {};
        document.querySelectorAll('.FormField').forEach(field => {
            const value = field.value.trim();
            if (value) {
                // ìˆ«ì í•„ë“œëŠ” ìˆ«ìë¡œ ë³€í™˜
                if (field.type === 'number') {
                    formData[field.name] = parseFloat(value);
                } else {
                    formData[field.name] = value;
                }
            }
        });
        return formData;
    }

    async generateDocument() {
        if (!this.selectedDocumentType) {
            this.showError('ë¬¸ì„œ íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
            return;
        }

        const formData = this.collectFormData();
        
        // í•„ìˆ˜ í•„ë“œ ê²€ì¦
        const requiredFields = document.querySelectorAll('.FormField[required]');
        let hasError = false;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                hasError = true;
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (hasError) {
            this.showError('í•„ìˆ˜ í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        // ì§„í–‰ ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(document.getElementById('ProgressModal'));
        modal.show();

        try {
            const response = await fetch('/api/documents/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    document_type: this.selectedDocumentType,
                    form_data: formData
                })
            });

            const result = await response.json();
            modal.hide();

            if (result.success) {
                this.displayGeneratedDocument(result.data);
            } else {
                this.showError('ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        } catch (error) {
            modal.hide();
            console.error('ë¬¸ì„œ ìƒì„± ì˜¤ë¥˜:', error);
            this.showError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜');
        }
    }

    displayGeneratedDocument(documentData) {
        const content = documentData.generated_content || 'ìƒì„±ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤';
        
        // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜ (ê¸°ë³¸ì ì¸ ë³€í™˜)
        const htmlContent = this.markdownToHtml(content);
        
        document.getElementById('GeneratedContent').innerHTML = `
            <div class="generated-document">
                ${htmlContent}
            </div>
            <hr>
            <div class="document-metadata">
                <h6>ë¬¸ì„œ ì •ë³´</h6>
                <ul class="list-unstyled small text-muted">
                    <li><strong>ë¬¸ì„œ íƒ€ì…:</strong> ${documentData.template_name}</li>
                    <li><strong>ìƒì„± ì‹œê°„:</strong> ${new Date(documentData.timestamp).toLocaleString('ko-KR')}</li>
                    <li><strong>ì¶œë ¥ í˜•ì‹:</strong> ${documentData.output_formats?.join(', ') || 'PDF'}</li>
                    <li><strong>ìƒíƒœ:</strong> ${documentData.status === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</li>
                </ul>
            </div>
        `;

        // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
        document.getElementById('ResultSection').style.display = 'block';
        
        // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        document.getElementById('ResultSection').scrollIntoView({ 
            behavior: 'smooth' 
        });

        this.currentFormData = documentData;
    }

    markdownToHtml(markdown) {
        return markdown
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^\*\*(.*)\*\*/gm, '<strong>$1</strong>')
            .replace(/^\* (.*$)/gm, '<li>$1</li>')
            .replace(/^- (.*$)/gm, '<li>$1</li>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/^(.+)$/gm, '<p>$1</p>')
            .replace(/<p><li>/g, '<ul><li>')
            .replace(/<\/li><\/p>/g, '</li></ul>');
    }

    copyToClipboard() {
        const content = document.getElementById('GeneratedContent').innerText;
        navigator.clipboard.writeText(content).then(() => {
            // ì„±ê³µ í”¼ë“œë°±
            const button = document.getElementById('CopyButton');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> ë³µì‚¬ë¨';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        });
    }

    downloadDocument() {
        if (!this.currentFormData) return;
        
        const content = this.currentFormData.generated_content || '';
        const filename = `${this.selectedDocumentType}_${new Date().toISOString().slice(0,10)}.txt`;
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    showError(message) {
        // ê°„ë‹¨í•œ ì•Œë¦¼ í‘œì‹œ
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.container-fluid').insertBefore(
            alertDiv, 
            document.querySelector('.container-fluid').firstChild
        );
        
        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    new DocumentGenerator();
});
</script>

<style>
.DocumentTypeItem.active {
    background-color: #007bff;
    color: white;
}

.DocumentTypeItem:hover {
    background-color: #f8f9fa;
}

.DocumentTypeItem.active:hover {
    background-color: #0056b3;
}

.generated-document {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: #f8f9fa;
    max-height: 500px;
    overflow-y: auto;
}

.generated-document h1,
.generated-document h2,
.generated-document h3 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

.generated-document h1 {
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.3rem;
}

.generated-document h2 {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.2rem;
}

.generated-document ul {
    margin: 0.5rem 0;
    padding-left: 2rem;
}

.generated-document li {
    margin: 0.2rem 0;
}

.FormField.is-invalid {
    border-color: #dc3545;
}

.document-metadata {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

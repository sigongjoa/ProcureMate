{% extends "base.html" %}

{% block title %}ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ - ProcureMate GUI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h1>
        <p class="text-muted">LLM â†’ ë°ì´í„° ìˆ˜ì§‘ â†’ RAG â†’ ë¬¸ì„œ ìƒì„±ì˜ ì „ì²´ í”„ë¡œì„¸ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤</p>
    </div>
</div>

<!-- ì›Œí¬í”Œë¡œìš° ì…ë ¥ -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ì›Œí¬í”Œë¡œìš° ì‹¤í–‰</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <label class="form-label">ì¡°ë‹¬ ìš”ì²­</label>
                        <textarea class="form-control" id="WorkflowInput" rows="3"
                                  placeholder="ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•  ì¡°ë‹¬ ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”">íšŒì˜ì‹¤ìš© í…Œì´ë¸” 5ê°œì™€ ì˜ì 20ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆì‚°ì€ 500ë§Œì› ì •ë„ì´ê³ , ë‹¤ìŒ ë‹¬ê¹Œì§€ ë‚©í’ˆë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-success btn-lg" onclick="runFullWorkflow()">
                                <span id="WorkflowButtonText">ğŸš€ ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:</h6>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadScenario('office')">ì‚¬ë¬´ìš©í’ˆ</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadScenario('meeting')">íšŒì˜ì‹¤</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadScenario('it')">IT ì¥ë¹„</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadScenario('furniture')">ê°€êµ¬</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì§„í–‰ ìƒí™© í‘œì‹œ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ì‹¤í–‰ ì§„í–‰ ìƒí™©</h5>
            </div>
            <div class="card-body">
                <div id="WorkflowProgress">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="workflow-step" id="Step1">
                                    <div class="step-icon">1</div>
                                    <h6>LLM ë¶„ì„</h6>
                                    <div class="step-status">ëŒ€ê¸°</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="workflow-step" id="Step2">
                                    <div class="step-icon">2</div>
                                    <h6>ë°ì´í„° ìˆ˜ì§‘</h6>
                                    <div class="step-status">ëŒ€ê¸°</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="workflow-step" id="Step3">
                                    <div class="step-icon">3</div>
                                    <h6>RAG ê²€ìƒ‰</h6>
                                    <div class="step-status">ëŒ€ê¸°</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="workflow-step" id="Step4">
                                    <div class="step-icon">4</div>
                                    <h6>ë¬¸ì„œ ìƒì„±</h6>
                                    <div class="step-status">ëŒ€ê¸°</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë‹¨ê³„ë³„ ê²°ê³¼ -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">1ë‹¨ê³„: LLM ë¶„ì„ ê²°ê³¼</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="LlmResults">
                    <p class="text-muted">ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">2ë‹¨ê³„: ë°ì´í„° ìˆ˜ì§‘ ê²°ê³¼</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="DataResults">
                    <p class="text-muted">ëŒ€ê¸° ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">3ë‹¨ê³„: RAG ê²€ìƒ‰ ê²°ê³¼</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="RagResults">
                    <p class="text-muted">ëŒ€ê¸° ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">4ë‹¨ê³„: ë¬¸ì„œ ìƒì„± ê²°ê³¼</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="DocumentResults">
                    <p class="text-muted">ëŒ€ê¸° ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì „ì²´ ì„±ëŠ¥ ìš”ì•½ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ì„±ëŠ¥ ìš”ì•½ & ì°¨íŠ¸</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="PerformanceSummary">
                            <p class="text-muted">ëŒ€ê¸° ì¤‘...</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <canvas id="WorkflowChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì›ë³¸ ê²°ê³¼ ë°ì´í„° -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ì „ì²´ ê²°ê³¼ ë°ì´í„°</h5>
            </div>
            <div class="card-body">
                <div id="RawWorkflowData" style="display: none;">
                    <pre id="WorkflowJson" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <button class="btn btn-outline-secondary" onclick="toggleRawData()">
                    ì›ë³¸ ë°ì´í„° ë³´ê¸°/ìˆ¨ê¸°ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.workflow-step {
    padding: 20px;
    border-radius: 10px;
    margin: 10px 0;
    transition: all 0.3s ease;
}

.step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
    font-size: 18px;
}

.workflow-step.waiting {
    background-color: #f8f9fa;
    border: 2px solid #e9ecef;
}

.workflow-step.running {
    background-color: #fff3cd;
    border: 2px solid #ffc107;
}

.workflow-step.running .step-icon {
    background-color: #ffc107;
    color: white;
    animation: pulse 1.5s infinite;
}

.workflow-step.completed {
    background-color: #d1eddc;
    border: 2px solid #28a745;
}

.workflow-step.completed .step-icon {
    background-color: #28a745;
    color: white;
}

.workflow-step.error {
    background-color: #f8d7da;
    border: 2px solid #dc3545;
}

.workflow-step.error .step-icon {
    background-color: #dc3545;
    color: white;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.step-status {
    font-size: 14px;
    font-weight: 500;
}
</style>

{% endblock %}

{% block scripts %}
<script>
    let workflowChart = null;
    let currentWorkflowData = null;
    
    // ì•ˆì „í•œ ìˆ«ì ë³€í™˜ í—¬í¼ í•¨ìˆ˜
    function safeNumber(value, defaultValue = 0) {
        return (typeof value === 'number' && !isNaN(value)) ? value : defaultValue;
    }
    
    // ì•ˆì „í•œ toFixed í—¬í¼ í•¨ìˆ˜
    function safeToFixed(value, digits = 2, defaultValue = '0.00') {
        const num = safeNumber(value);
        return num.toFixed(digits);
    }
    
    // ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
    async function runFullWorkflow() {
        const query = document.getElementById('WorkflowInput').value;
        if (!query.trim()) {
            alert('ì¡°ë‹¬ ìš”ì²­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // UI ì´ˆê¸°í™”
        resetWorkflowUI();
        setWorkflowState(true);
        
        try {
            const response = await fetch('/api/workflow/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query})
            });
            
            const result = await response.json();
            currentWorkflowData = result;
            
            if (result.success) {
                displayWorkflowResults(result);
            } else {
                displayWorkflowError(result);
            }
            
        } catch (error) {
            console.error('ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì˜¤ë¥˜:', error);
            displayWorkflowError({error: error.message});
        } finally {
            setWorkflowState(false);
        }
    }
    
    // ì›Œí¬í”Œë¡œìš° ê²°ê³¼ í‘œì‹œ
    function displayWorkflowResults(result) {
        const workflowResults = result.workflow_results || {};
        const metrics = result.metrics || {};
        
        // ê° ë‹¨ê³„ ê²°ê³¼ í‘œì‹œ
        if (workflowResults.llm_analysis) {
            updateStepStatus(1, 'completed');
            displayLlmResults(workflowResults.llm_analysis);
        }
        
        if (workflowResults.data_collection) {
            updateStepStatus(2, 'completed');
            displayDataResults(workflowResults.data_collection);
        }
        
        if (workflowResults.rag_search) {
            updateStepStatus(3, 'completed');
            displayRagResults(workflowResults.rag_search);
        }
        
        if (workflowResults.document_generation) {
            updateStepStatus(4, 'completed');
            displayDocumentResults(workflowResults.document_generation);
        }
        
        // ì„±ëŠ¥ ìš”ì•½ í‘œì‹œ
        displayPerformanceSummary(metrics, workflowResults);
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateWorkflowChart(metrics, workflowResults);
        
        // ì›ë³¸ ë°ì´í„° ì €ì¥
        document.getElementById('WorkflowJson').textContent = JSON.stringify(result, null, 2);
    }
    
    // LLM ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    function displayLlmResults(llmData) {
        const div = document.getElementById('LlmResults');
        const analysis = llmData.result || {};
        const duration = safeNumber(llmData.duration);
        
        div.innerHTML = `
            <div class="mb-3">
                <h6>ë¶„ì„ ì™„ë£Œ (${safeToFixed(duration)}ì´ˆ)</h6>
            </div>
            
            <div class="mb-2">
                <strong>ì¶”ì¶œëœ ë¬¼í’ˆ:</strong>
                <ul class="list-unstyled ms-3">
                    ${analysis.items && analysis.items.length > 0 ? 
                      analysis.items.map(item => `<li>â€¢ ${item}</li>`).join('') : 
                      '<li>â€¢ ì—†ìŒ</li>'}
                </ul>
            </div>
            
            <div class="mb-2">
                <strong>ìˆ˜ëŸ‰:</strong>
                ${analysis.quantities && analysis.quantities.length > 0 ? analysis.quantities.join(', ') : 'ë¯¸ì •'}
            </div>
            
            <div class="mb-2">
                <strong>ì˜ˆì‚° ë²”ìœ„:</strong> ${analysis.budget_range || 'ë¯¸ì •'}
            </div>
            
            <div class="mb-2">
                <strong>ê¸´ê¸‰ë„:</strong> ${analysis.urgency || 'ë³´í†µ'}
            </div>
            
            <div class="mb-2">
                <strong>íŠ¹ë³„ ìš”êµ¬ì‚¬í•­:</strong> 
                ${analysis.specifications && analysis.specifications.length > 0 ? 
                  analysis.specifications.join(', ') : 'ì—†ìŒ'}
            </div>
        `;
    }
    
    // ë°ì´í„° ìˆ˜ì§‘ ê²°ê³¼ í‘œì‹œ
    function displayDataResults(dataCollection) {
        const div = document.getElementById('DataResults');
        const searchResults = dataCollection.result || {};
        const duration = safeNumber(dataCollection.duration);
        
        let resultsHtml = `
            <div class="mb-3">
                <h6>ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ (${safeToFixed(duration)}ì´ˆ)</h6>
            </div>
        `;
        
        const resultCount = Object.keys(searchResults).length;
        if (resultCount === 0) {
            resultsHtml += '<p class="text-muted">ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            for (const [item, platforms] of Object.entries(searchResults)) {
                resultsHtml += `
                    <div class="mb-3">
                        <strong>"${item}" ê²€ìƒ‰ ê²°ê³¼:</strong>
                        <div class="ms-3">
                `;
                
                for (const [platform, products] of Object.entries(platforms || {})) {
                    const productList = Array.isArray(products) ? products : [];
                    resultsHtml += `
                        <div class="mb-2">
                            <span class="badge bg-secondary">${platform}</span>
                            <small>(${productList.length}ê°œ ìƒí’ˆ)</small>
                            <ul class="list-unstyled ms-3 mt-1">
                    `;
                    
                    productList.slice(0, 2).forEach(product => {
                        const name = product.name || product.title || 'ìƒí’ˆëª… ì—†ìŒ';
                        const price = product.price ? ` - ${product.price}` : '';
                        resultsHtml += `<li class="small">â€¢ ${name}${price}</li>`;
                    });
                    
                    if (productList.length > 2) {
                        resultsHtml += `<li class="small text-muted">... ì™¸ ${productList.length - 2}ê°œ</li>`;
                    }
                    
                    resultsHtml += '</ul></div>';
                }
                
                resultsHtml += '</div></div>';
            }
        }
        
        div.innerHTML = resultsHtml;
    }
    
    // RAG ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function displayRagResults(ragData) {
        const div = document.getElementById('RagResults');
        const ragResult = ragData.result || {};
        const duration = safeNumber(ragData.duration);
        const similarProducts = ragResult.similar_products || [];
        const similarCases = ragResult.similar_cases || [];
        
        div.innerHTML = `
            <div class="mb-3">
                <h6>RAG ê²€ìƒ‰ ì™„ë£Œ (${safeToFixed(duration)}ì´ˆ)</h6>
            </div>
            
            <div class="mb-3">
                <strong>ìœ ì‚¬ ìƒí’ˆ (${similarProducts.length}ê°œ):</strong>
                <ul class="list-unstyled ms-3">
                    ${similarProducts.length === 0 ? 
                      '<li class="small text-muted">ìœ ì‚¬ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</li>' :
                      similarProducts.slice(0, 3).map(product => {
                        const content = product.document || product.content || 'ë‚´ìš© ì—†ìŒ';
                        const similarity = product.distance ? 
                          safeToFixed(1 - product.distance) : 'N/A';
                        return `
                          <li class="small">
                            â€¢ ${content.substring(0, 100)}...
                            <span class="badge bg-primary ms-2">
                              ìœ ì‚¬ë„: ${similarity}
                            </span>
                          </li>
                        `;
                      }).join('')
                    }
                </ul>
            </div>
            
            <div class="mb-3">
                <strong>ìœ ì‚¬ ì¡°ë‹¬ ì‚¬ë¡€ (${similarCases.length}ê°œ):</strong>
                <ul class="list-unstyled ms-3">
                    ${similarCases.length === 0 ?
                      '<li class="small text-muted">ìœ ì‚¬ ì¡°ë‹¬ ì‚¬ë¡€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>' :
                      similarCases.slice(0, 2).map(case_ => {
                        const content = case_.document || case_.content || 'ë‚´ìš© ì—†ìŒ';
                        return `<li class="small">â€¢ ${content.substring(0, 100)}...</li>`;
                      }).join('')
                    }
                </ul>
            </div>
        `;
    }
    
    // ë¬¸ì„œ ìƒì„± ê²°ê³¼ í‘œì‹œ
    function displayDocumentResults(docData) {
        const div = document.getElementById('DocumentResults');
        const documents = docData.result || {};
        const duration = safeNumber(docData.duration);
        
        div.innerHTML = `
            <div class="mb-3">
                <h6>ë¬¸ì„œ ìƒì„± ì™„ë£Œ (${safeToFixed(duration)}ì´ˆ)</h6>
            </div>
            
            <div class="mb-3">
                <strong>ìƒì„±ëœ ë¬¸ì„œë“¤:</strong>
                <ul class="list-unstyled ms-3">
                    ${Object.keys(documents).length === 0 ? 
                      '<li class="text-muted">ìƒì„±ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</li>' :
                      Object.entries(documents).map(([docType, docData]) => {
                        const preview = docData && docData.content ? 
                          docData.content.toString().substring(0, 200) + '...' : 
                          'ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ';
                        return `
                          <li class="mb-2">
                            <span class="badge bg-success">${docType}</span>
                            <div class="small mt-1">${preview}</div>
                          </li>
                        `;
                      }).join('')
                    }
                </ul>
            </div>
        `;
    }
    
    // ì„±ëŠ¥ ìš”ì•½ í‘œì‹œ
    function displayPerformanceSummary(metrics, workflowResults) {
        const div = document.getElementById('PerformanceSummary');
        const totalTime = safeNumber(metrics.response_time || metrics.total_time);
        const additionalMetrics = metrics.additional_metrics || {};
        const successStages = safeNumber(additionalMetrics.success_stages, 0);
        
        // ê° ë‹¨ê³„ë³„ ì‹œê°„ ì¶”ì¶œ
        const llmTime = safeNumber(workflowResults.llm_analysis?.duration || additionalMetrics.llm_analysis);
        const dataTime = safeNumber(workflowResults.data_collection?.duration || additionalMetrics.data_collection);
        const ragTime = safeNumber(workflowResults.rag_search?.duration || additionalMetrics.rag_search);
        const docTime = safeNumber(workflowResults.document_generation?.duration || additionalMetrics.document_generation);
        
        div.innerHTML = `
            <h6>ì „ì²´ ì„±ëŠ¥ ìš”ì•½</h6>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><strong>ì´ ì‹¤í–‰ ì‹œê°„:</strong> ${safeToFixed(totalTime)}ì´ˆ</li>
                        <li><strong>ì„±ê³µí•œ ë‹¨ê³„:</strong> ${successStages}/4</li>
                        <li><strong>LLM ë¶„ì„:</strong> ${safeToFixed(llmTime)}ì´ˆ</li>
                        <li><strong>ë°ì´í„° ìˆ˜ì§‘:</strong> ${safeToFixed(dataTime)}ì´ˆ</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li><strong>RAG ê²€ìƒ‰:</strong> ${safeToFixed(ragTime)}ì´ˆ</li>
                        <li><strong>ë¬¸ì„œ ìƒì„±:</strong> ${safeToFixed(docTime)}ì´ˆ</li>
                        <li><strong>í‰ê·  ë‹¨ê³„ ì‹œê°„:</strong> ${safeToFixed(totalTime / 4)}ì´ˆ</li>
                        <li><strong>ì „ì²´ ì„±ê³µë¥ :</strong> ${safeToFixed((successStages / 4) * 100, 1)}%</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    // ì›Œí¬í”Œë¡œìš° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateWorkflowChart(metrics, workflowResults) {
        const additionalMetrics = metrics.additional_metrics || {};
        
        const data = [
            safeNumber(workflowResults.llm_analysis?.duration || additionalMetrics.llm_analysis),
            safeNumber(workflowResults.data_collection?.duration || additionalMetrics.data_collection),
            safeNumber(workflowResults.rag_search?.duration || additionalMetrics.rag_search),
            safeNumber(workflowResults.document_generation?.duration || additionalMetrics.document_generation)
        ];
        
        if (!workflowChart) {
            const ctx = document.getElementById('WorkflowChart').getContext('2d');
            workflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['LLM ë¶„ì„', 'ë°ì´í„° ìˆ˜ì§‘', 'RAG ê²€ìƒ‰', 'ë¬¸ì„œ ìƒì„±'],
                    datasets: [{
                        label: 'ì‹¤í–‰ ì‹œê°„ (ì´ˆ)',
                        data: data,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderColor: [
                            'rgb(54, 162, 235)',
                            'rgb(255, 99, 132)',
                            'rgb(255, 205, 86)',
                            'rgb(75, 192, 192)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ì‹œê°„ (ì´ˆ)'
                            }
                        }
                    }
                }
            });
        } else {
            workflowChart.data.datasets[0].data = data;
            workflowChart.update();
        }
    }
    
    // ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStepStatus(stepNum, status) {
        const step = document.getElementById(`Step${stepNum}`);
        step.className = `workflow-step ${status}`;
        
        const statusText = step.querySelector('.step-status');
        const statusTexts = {
            waiting: 'ëŒ€ê¸°',
            running: 'ì‹¤í–‰ ì¤‘...',
            completed: 'ì™„ë£Œ',
            error: 'ì˜¤ë¥˜'
        };
        statusText.textContent = statusTexts[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
    
    // ì›Œí¬í”Œë¡œìš° UI ìƒíƒœ ì„¤ì •
    function setWorkflowState(running) {
        const button = document.querySelector('#WorkflowButtonText');
        if (running) {
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘...';
        } else {
            button.textContent = 'ğŸš€ ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰';
        }
    }
    
    // ì›Œí¬í”Œë¡œìš° UI ì´ˆê¸°í™”
    function resetWorkflowUI() {
        // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
        for (let i = 1; i <= 4; i++) {
            updateStepStatus(i, 'waiting');
        }
        
        // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
        document.getElementById('LlmResults').innerHTML = '<p class="text-muted">ì‹¤í–‰ ì¤‘...</p>';
        document.getElementById('DataResults').innerHTML = '<p class="text-muted">ëŒ€ê¸° ì¤‘...</p>';
        document.getElementById('RagResults').innerHTML = '<p class="text-muted">ëŒ€ê¸° ì¤‘...</p>';
        document.getElementById('DocumentResults').innerHTML = '<p class="text-muted">ëŒ€ê¸° ì¤‘...</p>';
        document.getElementById('PerformanceSummary').innerHTML = '<p class="text-muted">ëŒ€ê¸° ì¤‘...</p>';
    }
    
    // ì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜ í‘œì‹œ
    function displayWorkflowError(result) {
        // ì‹¤íŒ¨í•œ ë‹¨ê³„ë“¤ì„ ì˜¤ë¥˜ë¡œ í‘œì‹œ
        for (let i = 1; i <= 4; i++) {
            updateStepStatus(i, 'error');
        }
        
        const errorHtml = `
            <div class="alert alert-danger">
                <h6>ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹¤íŒ¨</h6>
                <p>${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
                ${result.partial_results ? '<p>ì¼ë¶€ ê²°ê³¼ëŠ” ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>' : ''}
            </div>
        `;
        
        document.getElementById('LlmResults').innerHTML = errorHtml;
    }
    
    // ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ
    function loadScenario(scenario) {
        const scenarios = {
            office: 'ì‚¬ë¬´ìš© ì˜ì 10ê°œì™€ ì±…ìƒ 5ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆì‚°ì€ 300ë§Œì›ì´ê³ , 2ì£¼ ë‚´ ë°°ì†¡ í¬ë§í•©ë‹ˆë‹¤.',
            meeting: 'íšŒì˜ì‹¤ìš© í…Œì´ë¸” 2ê°œì™€ ì˜ì 16ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤. ê³ ê¸‰ ì¬ì§ˆë¡œ 500ë§Œì› ì˜ˆì‚°ì…ë‹ˆë‹¤.',
            it: 'ë…¸íŠ¸ë¶ 20ëŒ€ì™€ ëª¨ë‹ˆí„° 20ê°œ, í‚¤ë³´ë“œ ë§ˆìš°ìŠ¤ ì„¸íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. 1000ë§Œì› ì˜ˆì‚°ìœ¼ë¡œ ê¸‰íˆ í•„ìš”í•©ë‹ˆë‹¤.',
            furniture: 'ì‚¬ë¬´ì‹¤ ë¦¬ëª¨ë¸ë§ì„ ìœ„í•œ ì±…ìƒ 15ê°œ, ì˜ì 15ê°œ, íŒŒí‹°ì…˜ 10ê°œê°€ í•„ìš”í•©ë‹ˆë‹¤. ì˜ˆì‚° 800ë§Œì›ì…ë‹ˆë‹¤.'
        };
        
        document.getElementById('WorkflowInput').value = scenarios[scenario] || '';
    }
    
    // ì›ë³¸ ë°ì´í„° í† ê¸€
    function toggleRawData() {
        const rawDiv = document.getElementById('RawWorkflowData');
        rawDiv.style.display = rawDiv.style.display === 'none' ? 'block' : 'none';
    }
    
    // ì—”í„°í‚¤ë¡œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
    document.getElementById('WorkflowInput').addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            runFullWorkflow();
        }
    });
</script>
{% endblock %}
